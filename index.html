<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imprime en Cibertic+ | Cotiza Aqu√≠ tus PDF¬¥s</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --azul-oscuro: #1e40af;
            --azul-medio: #3b82f6;
            --azul-claro: #eff6ff;
            --texto: #1e293b;
            --borde: #d1d5db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: var(--texto);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.1);
            border: 1px solid var(--azul-claro);
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { color: var(--azul-oscuro); margin: 0; font-size: 24px; }
        .header p { color: var(--azul-medio); font-size: 14px; margin: 5px 0; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--azul-oscuro); }
        input[type="text"] { 
            width: 100%; padding: 12px; border: 1px solid var(--borde); border-radius: 8px; box-sizing: border-box; font-size: 16px;
        }
        input:focus { border-color: var(--azul-medio); outline: none; background: var(--azul-claro); }

        .upload-area { 
            border: 2px dashed var(--azul-medio); padding: 20px; text-align: center; border-radius: 12px; 
            background: var(--azul-claro); cursor: pointer; margin-bottom: 15px; transition: 0.3s;
        }
        .upload-area:hover { background: #dbeafe; }

        /* Lista de Archivos */
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; border: 1px solid var(--borde); padding: 8px 12px;
            border-radius: 8px; margin-bottom: 5px; font-size: 13px;
        }
        .btn-remove {
            background: #ef4444; color: white; border: none; border-radius: 4px;
            width: 24px; height: 24px; cursor: pointer; font-weight: bold;
        }

        .hojas-badge { 
            background: var(--azul-oscuro); color: white; padding: 8px 15px; border-radius: 20px; 
            font-size: 14px; display: inline-block; margin-bottom: 15px; font-weight: bold;
        }

        .option-card { 
            border: 1px solid var(--borde); border-radius: 12px; padding: 15px; margin-bottom: 10px; 
            cursor: pointer; transition: 0.2s; text-align: left;
        }
        .option-card:hover { border-color: var(--azul-medio); }
        .option-card.selected { border-color: var(--azul-oscuro); background-color: var(--azul-claro); border-width: 2px; }
        .price-text { font-size: 1.5em; font-weight: bold; color: var(--azul-oscuro); }

        .btn-ws { 
            background-color: #25d366; color: white; border: none; padding: 15px; border-radius: 10px; 
            font-weight: bold; font-size: 16px; width: 100%; cursor: pointer; margin-top: 15px;
        }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; }

        /* Ticket Digital Oculto */
        #ticket-wrap { position: absolute; left: -9999px; }
        .ticket-visual { width: 300px; background: white; padding: 20px; color: black; border: 1px solid black; font-family: monospace; }
        
        .contact-link { display: block; text-align: center; margin-top: 15px; color: var(--azul-medio); text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üñ®Ô∏è Imprime Cibertic</h1>
        <p>Cotizador de Archivos</p>
    </div>

    <div class="input-group">
        <label>Nombre del Cliente:</label>
        <input type="text" id="c-nombre" placeholder="Nombre completo" oninput="validar()">
    </div>
    <div class="input-group">
        <label>Tel√©fono (10 d√≠gitos):</label>
        <input type="text" id="c-tel" placeholder="WhatsApp" oninput="validar()">
    </div>

    <div class="upload-area" onclick="document.getElementById('pdf-files').click()">
        <strong>üìÅ Haz clic para subir PDFs</strong>
        <p style="font-size: 12px; margin: 5px 0 0 0;">Puedes subir hasta 5 archivos</p>
        <input type="file" id="pdf-files" accept="application/pdf" multiple style="display:none">
    </div>

    <div id="file-list-container"></div>

    <div id="results" style="display:none; text-align: center; margin-top: 20px;">
        <div class="hojas-badge">Total Hojas: <span id="span-total-hojas">0</span></div>
        
        <div class="option-card" onclick="selectOption('INTELIGENTE (Mix)', costos.mixto)" id="opt-mixto">
            <small style="color: var(--azul-medio); font-weight: bold;">MODALIDAD MIXTA</small>
            <div class="price-text" id="txt-mixto">$0.00</div>
        </div>
        <div class="option-card" onclick="selectOption('TODO EN B&N', costos.bn)" id="opt-bn">
            <small style="color: #64748b; font-weight: bold;">MODALIDAD ECON√ìMICA</small>
            <div class="price-text" id="txt-bn">$0.00</div>
        </div>
        <div class="option-card" onclick="selectOption('TODO A COLOR', costos.color)" id="opt-color">
            <small style="color: var(--azul-oscuro); font-weight: bold;">MODALIDAD PREMIUM</small>
            <div class="price-text" id="txt-color">$0.00</div>
        </div>

        <button id="ws-btn" class="btn-ws" onclick="generarPedido()" disabled>GENERAR TICKET Y ENVIAR</button>
    </div>

    <a href="https://wa.me/529615528684" class="contact-link" target="_blank">¬øTienes dudas? Cont√°ctanos üí¨</a>
</div>

<div id="ticket-wrap">
    <div id="ticket-canvas" class="ticket-visual">
        <div style="text-align: center; border-bottom: 1px dashed black; padding-bottom: 10px; margin-bottom: 10px;">
            <strong>IMPRESIONES PRO</strong><br>
            <span id="t-folio"></span><br>
            <small id="t-fecha"></small>
        </div>
        <div style="font-size: 12px;">
            <strong>CLIENTE:</strong> <span id="t-nombre"></span><br>
            <strong>TEL:</strong> <span id="t-tel"></span><br>
            <hr>
            <strong>ARCHIVOS:</strong><br>
            <div id="t-archivos"></div>
            <br>
            <strong>TOTAL HOJAS:</strong> <span id="t-hojas"></span><br>
            <strong>MODALIDAD:</strong> <span id="t-mod"></span>
        </div>
        <div style="text-align: center; border-top: 1px dashed black; margin-top: 10px; padding-top: 10px; font-size: 18px; font-weight: bold;">
            TOTAL: <span id="t-total"></span> MXN
        </div>
    </div>
</div>

<script>
    const PRECIOS = { BN: 1.25, TEXTO_COL: 1.50, FULL_COL: 2.50, MINIMO: 5.00 };
    const MI_TELEFONO = "529615528684"; // Cambiar por tu n√∫mero real

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let archivosCargados = []; // Array de objetos {nombre, paginas, costoMixto}
    let costos = { mixto: 0, bn: 0, color: 0 };
    let opcionSeleccionada = "";
    let precioSeleccionado = 0;

    document.getElementById('pdf-files').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        
        for (const file of files) {
            if (archivosCargados.length >= 5) {
                alert("M√°ximo 5 archivos permitidos.");
                break;
            }
            // Evitar duplicados por nombre
            if (archivosCargados.some(a => a.nombre === file.name)) continue;

            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
            let costoM = 0;
            const numP = pdf.numPages;

            for (let i = 1; i <= numP; i++) {
                const page = await pdf.getPage(i);
                const op = await page.getOperatorList();
                const hasImg = op.fnArray.some(f => f === pdfjsLib.OPS.paintJpegXObject || f === pdfjsLib.OPS.paintImageXObject);
                const hasCol = op.fnArray.some(f => f === pdfjsLib.OPS.setFillRGBColor);
                
                if (hasCol && hasImg) costoM += PRECIOS.FULL_COL;
                else if (hasCol) costoM += PRECIOS.TEXTO_COL;
                else costoM += PRECIOS.BN;
            }

            archivosCargados.push({
                nombre: file.name,
                paginas: numP,
                costoMixto: costoM
            });
        }
        actualizarUI();
    });

    function eliminarArchivo(index) {
        archivosCargados.splice(index, 1);
        actualizarUI();
    }

    function actualizarUI() {
        const container = document.getElementById('file-list-container');
        container.innerHTML = "";
        
        let totalHojas = 0;
        costos = { mixto: 0, bn: 0, color: 0 };

        archivosCargados.forEach((arc, index) => {
            totalHojas += arc.paginas;
            
            // Regla de $5 por archivo de 1 hoja
            if (arc.paginas === 1) {
                costos.mixto += PRECIOS.MINIMO;
                costos.bn += PRECIOS.MINIMO;
                costos.color += PRECIOS.MINIMO;
            } else {
                costos.mixto += arc.costoMixto;
                costos.bn += (arc.paginas * PRECIOS.BN);
                costos.color += (arc.paginas * PRECIOS.FULL_COL);
            }

            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<span>${arc.nombre} (${arc.paginas} p√°g)</span>
                             <button class="btn-remove" onclick="eliminarArchivo(${index})">√ó</button>`;
            container.appendChild(div);
        });

        document.getElementById('span-total-hojas').innerText = totalHojas;
        document.getElementById('txt-mixto').innerText = `$${costos.mixto.toFixed(2)}`;
        document.getElementById('txt-bn').innerText = `$${costos.bn.toFixed(2)}`;
        document.getElementById('txt-color').innerText = `$${costos.color.toFixed(2)}`;
        
        document.getElementById('results').style.display = archivosCargados.length > 0 ? 'block' : 'none';
        validar();
    }

    function selectOption(tipo, precio) {
        opcionSeleccionada = tipo;
        precioSeleccionado = precio.toFixed(2);
        document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
        if(tipo.includes('Mix')) document.getElementById('opt-mixto').classList.add('selected');
        if(tipo.includes('B&N')) document.getElementById('opt-bn').classList.add('selected');
        if(tipo.includes('COLOR')) document.getElementById('opt-color').classList.add('selected');
        validar();
    }

    function validar() {
        const n = document.getElementById('c-nombre').value.trim().length > 3;
        const t = document.getElementById('c-tel').value.trim().length >= 10;
        document.getElementById('ws-btn').disabled = !(n && t && opcionSeleccionada !== "" && archivosCargados.length > 0);
    }

    async function generarPedido() {
        const folio = "AZ-" + Math.floor(Math.random() * 9999);
        document.getElementById('t-folio').innerText = "FOLIO: " + folio;
        document.getElementById('t-fecha').innerText = new Date().toLocaleString();
        document.getElementById('t-nombre').innerText = document.getElementById('c-nombre').value;
        document.getElementById('t-tel').innerText = document.getElementById('c-tel').value;
        document.getElementById('t-archivos').innerHTML = archivosCargados.map(a => `‚Ä¢ ${a.nombre} (${a.paginas} p√°g)`).join('<br>');
        document.getElementById('t-hojas').innerText = document.getElementById('span-total-hojas').innerText;
        document.getElementById('t-mod').innerText = opcionSeleccionada;
        document.getElementById('t-total').innerText = precioSeleccionado;

        const canvas = await html2canvas(document.getElementById('ticket-canvas'));
        const link = document.createElement('a');
        link.download = `Ticket_${folio}.png`;
        link.href = canvas.toDataURL();
        link.click();

        const msj = `*COTIZACI√ìN ${folio}*%0A` +
                   `üë§ *Cliente:* ${document.getElementById('c-nombre').value}%0A` +
                   `üìÑ *Total Hojas:* ${document.getElementById('span-total-hojas').innerText}%0A` +
                   `‚öôÔ∏è *Modo:* ${opcionSeleccionada}%0A` +
                   `üí∞ *TOTAL:* $${precioSeleccionado} MXN%0A%0A` +
                   `_Adjunto mis ${archivosCargados.length} archivos y el ticket generado._`;
        
        window.open(`https://wa.me/${MI_TELEFONO}?text=${msj}`, '_blank');
    }
</script>
</body>
</html>